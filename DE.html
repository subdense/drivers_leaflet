<!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
        <meta name="viewport" content="maximum-scale=1.0, user-scalable=no" />
        <title></title>
    </head>

    <body style="margin: 0; height: 100%; font-family: Arial, Helvetica, sans-serif; overflow: hidden">
        <div id="viz-container" style="height: 100%; width: 100%"></div>

        <div
            style="
                position: absolute;
                left: 20px;
                top: 20px;
                width: auto;
                height: auto;
                padding: 10px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 5px 5px 5px grey;
            "
        >
            <div id="layer">
                <span style="font-size: 1.5em; font-weight: bold">Population</span>
                <br />
                <span style="font-size: 1.2em">
                    <input type="radio" name="layer" id="pop" value="pop" checked />
                    <label for="pop">Total population</label>
                    <br />
                    <input type="radio" name="layer" id="popSex" value="popSex" />
                    <label for="popSex">By sex</label>
                    <br />
                    <input type="radio" name="layer" id="popMarital" value="popMarital" />
                    <label for="popMarital">By marital status</label>
                    <br />
                    <input type="radio" name="layer" id="popAge" value="popAge" />
                    <label for="popAge">By age</label>
                    <input type="radio" name="layer" id="ageR" value="ageR" />
                    <label for="ageR">Age balance</label>
                    <br />
                    <input type="radio" name="layer" id="popCoB" value="popCoB" />
                    <label for="popCoB">By birth place</label>
                    <input type="radio" name="layer" id="popCit" value="popCit" />
                    <label for="popCit">or citizenship</label> (<input
                        type="checkbox"
                        id="popCoBCitCB"
                        checked
                    />
                    <label for="popCoBCitCB">size by population</label>)
                    <br />
                    <input type="radio" name="layer" id="popRelig" value="popRelig" />
                    <label for="popRelig">By religion</label> (<input type="checkbox" id="popReligCB" />
                    <label for="popReligCB">size by population</label>)
                    <br />
                    <input type="radio" name="layer" id="popS" value="popS" />
                    <label for="popS">Smoothed</label>
                    <input type="range" min="3" max="30" value="10" class="slider" id="sigma" />
                    <br />
                </span>
                <span style="font-size: 1.5em; font-weight: bold">Habitation</span>
                <br />
                <span style="font-size: 1.2em">
                    <input type="radio" name="layer" id="habType" value="habType" />
                    <label for="habType">Building type</label>
                    <br />
                    <input type="radio" name="layer" id="habYear" value="habYear" />
                    <label for="habYear">Construction date</label>
                    <br />
                    <input type="radio" name="layer" id="habHeat" value="habHeat" />
                    <label for="habHeat">Heating system</label>
                </span>
            </div>
            <span style="font-size: 1.2em">
                <hr />
                <input type="checkbox" id="label" checked />
                <label for="label">City names</label>
                <input type="checkbox" id="boundary" checked />
                <label for="boundary">Boundaries</label>
                <input type="checkbox" id="background" checked />
                <label for="background">Background</label>
                <hr />
                Source:
                <a
                    href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html?nn=559100#Gitter"
                    style="text-decoration: none"
                    >Statistisches Bundesamt, Wiesbaden 2018</a
                >
            </span>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/gridviz@2.1.17"></script>
        <script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@1.0.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/gridviz-smoothing@1.0.2"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
        <script>
            let containerDiv = document.getElementById('viz-container')

            const app = new gviz.App(containerDiv)
                .setGeoCenter({ x: 4301000, y: 3050000 })
                .setZoomFactor(400)
                .setLabelLayer(gviz_es.getEuronymeLabelLayer('DE', '20'))
                .setBoundaryLayer(gviz_es.getEurostatBoundariesLayer())
                .addBackgroundLayerWMS({
                    url: 'https://sgx.geodatenzentrum.de/wms_basemapde?&service=WMS&request=GetMap&layers=de_basemapde_web_raster_grau&styles=&format=image%2Fjpeg&transparent=false&version=1.1.1&srs=EPSG%3A3035',
                    maxZoom: 50,
                })
                .addBackgroundLayer({
                    url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
                    resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
                    origin: [0, 6000000],
                    filterColor: (zf) => '#ffffff60',
                    minZoom: 50,
                })

            //prepare datasets, indexed by thematic domain and year
            const ds = {}

            //TODO
            const cleanCell = (c) => {
                for (let k of Object.keys(c)) c[k] = +c[k]
            }

            const baseURLCSV =
                'https://raw.githubusercontent.com/jgaffuri/tiled-grid-germany-zensus2011/main/out/'
            const makeDataset = (code, preprocess) => {
                return app.makeMultiScaleTiledGridDataset(
                    [100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000],
                    (r) => baseURLCSV + code + 'csv/' + r + 'm/',
                    { preprocess: preprocess }
                )
            }

            //total population
            ds.INSGESAMT = makeDataset('INSGESAMT', (c) => {
                cleanCell(c)
            })

            //sex
            ds.GESCHLECHT = makeDataset('GESCHLECHT', (c) => {
                cleanCell(c)
                c.TOT = c['1'] + c['2']
                c.I = c['1'] - c['2']
                c.I = (100 * c.I) / c.TOT
                if (isNaN(c.I)) c.I = 0
            })

            //marital status
            ds.FAMSTND_AUSF = makeDataset('FAMSTND_AUSF', (c) => {
                cleanCell(c)
                c.TOT = 0
                for (let i = 1; i <= 8; i++) c.TOT += c[i]
                c.S = c['1']
                c.M = c['2'] + c['5']
                c.D = c['4'] + c['7']
                c.W = c['3'] + c['6']
                c.ND = c['8']
            })

            //age
            ds.ALTER_KURZ = makeDataset('ALTER_KURZ', (c) => {
                cleanCell(c)
                c.TOT = 0
                for (let i = 1; i <= 5; i++) c.TOT += c[i]
                //age ratio
                //<29
                c.yyy = +c['1'] + c['2']
                //>50
                c.ooo = +c['4'] + c['5']
                c.age_ratio = c.yyy + c.ooo == 0 ? 0 : (c.yyy - c.ooo) / (c.yyy + c.ooo)
                c.age_ratio = c.age_ratio * 0.5 + 0.5
            })

            //place of birth
            ds.GEBURTLAND_GRP = makeDataset('GEBURTLAND_GRP', (c) => {
                cleanCell(c)
                c.TOT = c['1'] + c['21'] + c['22'] + c['23'] + c['24']
            })

            //citizenship
            ds.STAATSANGE_GRP = makeDataset('STAATSANGE_GRP', (c) => {
                cleanCell(c)
                c.TOT = c['1'] + c['21'] + c['22'] + c['23'] + c['24']
            })

            //religion
            ds.RELIGION_KURZ = makeDataset('RELIGION_KURZ', (c) => {
                cleanCell(c)
                c.TOT = c['1'] + c['2'] + c['3']
            })

            //building type
            ds.GEBTYPBAUWEISE = makeDataset('GEBTYPBAUWEISE', (c) => {
                cleanCell(c)
                c.TOT = 0
                for (let i = 1; i <= 4; i++) c.TOT += c[i]
            })

            //building age
            ds.BAUJAHR_MZ = makeDataset('BAUJAHR_MZ', (c) => {
                cleanCell(c)
                c.TOT = 0
                for (let i = 1; i <= 10; i++) c.TOT += c[i]
            })

            //heating system
            ds.HEIZTYP = makeDataset('HEIZTYP', (c) => {
                cleanCell(c)
                c.TOT = 0
                for (let i = 1; i <= 6; i++) c.TOT += c[i]

                c.fernw = c['1']
                c.etagen = c['2']
                c.zentral = c['4']
                c.sonst = c['3'] + c['5'] + c['6']
                for (let i = 1; i <= 6; i++) delete c[i]
            })

            //
            const update = () => {
                //read GUI selection
                const layCode = document.querySelector('input[name="layer"]:checked').value

                //remove layers
                app.layers = []

                //formater
                //const f1 = d3.format('.1f')

                //set layer
                if (layCode === 'pop') {
                    app.addLayerFromDataset(
                        ds.INSGESAMT,
                        [
                            new gviz.SquareColorWGLStyle({
                                colorCol: '0',
                                color: d3.interpolateYlOrRd,
                                stretching: { fun: 'expRev', alpha: -7 },
                                //set alpha and blend operation
                                //alpha: (zf) => zf < 70 ? 0.75 : 1.0,
                                blendOperation: (zf) => (zf < 10 ? 'multiply' : 'source-over'),
                            }),
                            new gviz.StrokeStyle({ maxZoom: 7 }),
                        ],
                        {
                            pixNb: 1.5,
                            cellInfoHTML: (c) => '<b>' + c['0'] + '</b> person' + (+c['0'] == 1 ? '' : 's'),
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Population',
                            colorRamp: d3.interpolateYlOrRd,
                            fun: (t, r, s) => s.max * gviz.sExpRevInverse(t, -7),
                        })
                    )
                } else if (layCode === 'popS') {
                    const sig = document.querySelector('#sigma').value
                    const colR = d3.interpolateYlOrRd
                    const nb = 5

                    app.addLayerFromDataset(
                        ds.INSGESAMT,
                        [
                            new gviz_sm.KernelSmoothingStyle({
                                value: (c) => +c['0'],
                                filterSm: (v) => v > 0.001,
                                sigma: (r, zf) => (r * +sig) / 10,
                                factor: 2,
                                styles: [
                                    new gviz.SquareColorWGLStyle({
                                        colorCol: 'ksmval',
                                        color: colR,
                                        //stretching: { fun: 'expRev', alpha: -7 },
                                        tFun: (v, r, s) => {
                                            const v_ = gviz.sExpRev(v / s.max, -10)
                                            const cl = Math.floor(nb * v_) / nb
                                            return cl
                                        },
                                        //set alpha and blend operation
                                        //alpha: (zf) => zf < 70 ? 0.75 : 1.0,
                                        blendOperation: (zf) => (zf < 50 ? 'multiply' : 'source-over'),
                                    }),
                                ],
                            }),
                        ],
                        {
                            pixNb: 1.5,
                            cellInfoHTML: (c) => '<b>' + c['0'] + '</b> person' + (+c['0'] == 1 ? '' : 's'),
                        }
                    )

                    //legend
                    app.layers[0].styles[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Population',
                            colorRamp: (t) => colR(Math.floor(t * nb) / nb),
                            //width: 500,
                            //ticks: 6,
                            //fun: (t, r, s) => s.min + (s.max - s.min) * gviz.sExpRevInverse(t, -7),
                            width: 200,
                            ticks: 2,
                            tickFormat: 'text',
                            fun: (t, r, s) => (t == 0 ? 'Low' : t == 1 ? 'High' : 'X'),
                        })
                    )
                } else if (layCode === 'popSex') {
                    const fs = d3.format('.1f')

                    app.addLayerFromDataset(
                        //ds.demo,
                        ds.GESCHLECHT,
                        [
                            new gviz.ShapeColorSizeStyle({
                                colorCol: 'I',
                                color: (v, r, s) => {
                                    const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                                    const t = (Math.sign(v) * gviz.sPow(Math.abs(v) / max, 0.2)) / 2 + 0.5
                                    return d3.interpolateSpectral(1 - t)
                                },
                                shape: () => 'circle',
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1.3 * r * gviz.sPow(v / s.max, 0.2),
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 8,
                            cellInfoHTML: (c) => {
                                return (
                                    c['1'] +
                                    ' men<br>' +
                                    c['2'] +
                                    ' women<br>Difference: <b>' +
                                    (c.I > 0 ? '+' : '') +
                                    fs(c.I) +
                                    ' % men</b>'
                                )
                            },
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({ shape: 'circle', labelUnitText: 'inhab.', fillColor: '#ccc' })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Men / women difference',
                            ticks: 3,
                            //ticks: 5,
                            tickFormat: 'text',
                            //tickFormat: '.1f',
                            colorRamp: d3.interpolateSpectral,
                            invert: true,
                            fun: (t, r, s) => (t == 0 ? 'More women' : t == 0.5 ? 'Balanced' : 'More men'),
                            /*fun: (t, r, s) => {
                            const max = Math.max(Math.abs(s.min), Math.abs(s.max))
                            return (t < 0.5 ? -1 : 1) * max * gviz.sPow(Math.abs(2 * t - 1), 1 / 0.2)
                        },*/
                        })
                    )
                } else if (layCode === 'popMarital') {
                    //population by marital status
                    /*
                                    FAMSTND_AUSF
                S 1 Single
                M 2 Married 5 Party to a civil union
                D 4 Divorced (including annulled marriages) 7 Civil union annulled
                W 3 Widowed 6 Civil partner deceased (including “civil union dissolved by death” and “civil union dissolved by declaration of death”)
                ND 8 No data
                */

                    app.addLayerFromDataset(
                        ds.FAMSTND_AUSF,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    S: '#33a02c', //green
                                    M: '#ff7f00', //orange
                                    D: '#1f78b4', //blue,
                                    W: '#6a3d9a', //purple
                                    ND: '#ddd', //gray
                                },
                                type: () => 'segment', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1 * r * gviz.sPow(v / s.max, 0.25, 0),
                                stripesOrientation: () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: (zf) => (zf < 6 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 12,
                            cellInfoHTML: (c) =>
                                'Single: ' +
                                c.S +
                                '<br>' +
                                'Married / civil union: ' +
                                c.M +
                                '<br>' +
                                'Divorced / annulled: ' +
                                c.D +
                                '<br>' +
                                'Widowed / partner deceased: ' +
                                c.W +
                                '<br>' +
                                'No data: ' +
                                c.ND,
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'square',
                            labelUnitText: 'people',
                            fillColor: '#ccc',
                            //exaggerationFactor: 0.05,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Marital status',
                            shape: 'square',
                            colCat: [
                                ['#33a02c', 'Single'],
                                ['#ff7f00', 'Married / civil union'],
                                ['#1f78b4', 'Divorced / annulled'],
                                ['#6a3d9a', 'Widowed / partner deceased'],
                                ['#ddd', 'No data'],
                            ], //.reverse(),
                        })
                    )
                } else if (layCode === 'popAge') {
                    /*population by age (5 age groups)  ALTER_KURZ   1 Under 18     2 18 - 29    3 30 - 49    4 50 - 64   5 65 and over */

                    //const col = d3.interpolateSpectral
                    app.addLayerFromDataset(
                        ds.ALTER_KURZ,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    1: '#984ea3', //col(0.1),
                                    2: '#377eb8', //col(0.3),
                                    3: '#ffff33', //col(0.5),
                                    4: '#ff7f00', //col(0.7),
                                    5: '#e41a1c', //col(0.9),
                                },
                                type: () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => r * gviz.sPow(v / s.max, 0.25, 0),
                                stripesOrientation: () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 15,
                            cellInfoHTML: (c) =>
                                ' < 18 : ' +
                                c['1'] +
                                '<br>' +
                                ' 18-29 : ' +
                                c['2'] +
                                '<br>' +
                                ' 30-49 : ' +
                                c['3'] +
                                '<br>' +
                                ' 50-64 : ' +
                                c['4'] +
                                '<br>' +
                                ' > 64: ' +
                                c['5'],
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'square',
                            labelUnitText: 'people',
                            fillColor: '#ccc',
                            exaggerationFactor: 0.5,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Age',
                            shape: 'square',
                            colCat: [
                                ['#984ea3', '< 18'],
                                ['#377eb8', '18-29'],
                                ['#ffff33', '30-49'],
                                ['#ff7f00', '50-64'],
                                ['#e41a1c', ' > 64'],
                            ].reverse(),
                        })
                    )
                } else if (layCode === 'ageR') {
                    //young VS elderly
                    app.addLayerFromDataset(
                        ds.ALTER_KURZ,
                        [
                            new gviz.ShapeColorSizeStyle({
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1.4 * r * Math.pow(v / s.max, 0.2),
                                colorCol: 'age_ratio',
                                color: (v, r, s) => d3.interpolateSpectral(1 - v),
                                shape: () => 'circle',
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 7,
                            cellInfoHTML: (c) =>
                                '<b>' +
                                c.yyy +
                                '</b> person(s) aged 29 or younger' +
                                '<br>' +
                                '<b>' +
                                c.ooo +
                                '</b> person(s) aged 50 or elder',
                            //+ "<br>" + "(Balance: " + (Math.round(c.age_ratio * 100)) + "%)"
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'circle',
                            labelUnitText: 'people',
                            fillColor: '#ccc',
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorLegend({
                            title: 'Balance young / old',
                            ticks: 2,
                            tickFormat: 'text',
                            colorRamp: d3.interpolateSpectral,
                            fun: (t, r, s) => (t == 0 ? 'Younger' : t == 0.5 ? 'Balanced' : 'Elder'),
                        })
                    )
                } else if (layCode === 'popCoB') {
                    //population by country of birth

                    //GEBURTLAND_GRP
                    //1 Germany
                    //21 EU27
                    //22 Rest of Europe
                    //23 Rest of the world
                    //24 Other

                    const sized = document.querySelector('#popCoBCitCB').checked

                    app.addLayerFromDataset(
                        ds.GEBURTLAND_GRP,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    1: '#fed9a6', //light mostard
                                    21: '#7570b3', //blueish
                                    22: '#1b9e77', //greenish,
                                    23: '#d95f02', //orange
                                    24: '#ddd', //gray
                                },
                                type: sized ? () => 'halftone' : () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: sized
                                    ? (v, r, s, zf) => 1.3 * r * gviz.sPow(v / s.max, 0.25, 0)
                                    : undefined,
                                stripesOrientation: sized ? undefined : () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: sized
                                    ? undefined
                                    : (zf) => (zf < 6 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: sized ? 22 : 5,
                            cellInfoHTML: (c) =>
                                'Germany: ' +
                                c['1'] +
                                '<br>' +
                                'European union: ' +
                                c['21'] +
                                '<br>' +
                                'Rest of Europe: ' +
                                c['22'] +
                                '<br>' +
                                'Rest of the world: ' +
                                c['23'] +
                                '<br>' +
                                'Other: ' +
                                c['24'],
                        }
                    )
                    //legend
                    if (sized)
                        app.layers[0].styles[0].legends.push(
                            new gviz.SizeLegend({
                                shape: 'circle',
                                labelUnitText: 'people',
                                fillColor: '#ccc',
                                exaggerationFactor: 0.05,
                            })
                        )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Birth place',
                            shape: sized ? 'circle' : 'square',
                            colCat: [
                                ['#fed9a6', 'Germany'],
                                ['#7570b3', 'European union'],
                                ['#1b9e77', 'Rest of Europe'],
                                ['#d95f02', 'Rest of the world'],
                                ['#ddd', 'Other'],
                            ], //.reverse(),
                        })
                    )
                } else if (layCode === 'popCit') {
                    //population by citizenship
                    //STAATSANGE_GRP

                    const sized = document.querySelector('#popCoBCitCB').checked

                    app.addLayerFromDataset(
                        ds.STAATSANGE_GRP,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    1: '#fed9a6', //light mostard
                                    21: '#7570b3', //blueish
                                    22: '#1b9e77', //greenish,
                                    23: '#d95f02', //orange
                                    24: '#ddd', //gray
                                },
                                type: sized ? () => 'halftone' : () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: sized
                                    ? (v, r, s, zf) => 1.3 * r * gviz.sPow(v / s.max, 0.25, 0)
                                    : undefined,
                                stripesOrientation: sized ? undefined : () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: sized
                                    ? undefined
                                    : (zf) => (zf < 6 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: sized ? 22 : 5,
                            cellInfoHTML: (c) =>
                                'Germany: ' +
                                c['1'] +
                                '<br>' +
                                'European union: ' +
                                c['21'] +
                                '<br>' +
                                'Rest of Europe: ' +
                                c['22'] +
                                '<br>' +
                                'Rest of the world: ' +
                                c['23'] +
                                '<br>' +
                                'Other: ' +
                                c['24'],
                        }
                    )
                    //legend
                    if (sized)
                        app.layers[0].styles[0].legends.push(
                            new gviz.SizeLegend({
                                shape: 'circle',
                                labelUnitText: 'people',
                                fillColor: '#ccc',
                                exaggerationFactor: 0.05,
                            })
                        )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Citizenship',
                            shape: sized ? 'circle' : 'square',
                            colCat: [
                                ['#fed9a6', 'Germany'],
                                ['#7570b3', 'European union'],
                                ['#1b9e77', 'Rest of Europe'],
                                ['#d95f02', 'Rest of the world'],
                                ['#ddd', 'Other'],
                            ], //.reverse(),
                        })
                    )
                } else if (layCode === 'popRelig') {
                    //population by religion
                    //RELIGION_KURZ
                    //1 Roman Catholic Church
                    //2 Evangelical Church
                    //3 Other, none, no data

                    const sized = document.querySelector('#popReligCB').checked

                    app.addLayerFromDataset(
                        ds.RELIGION_KURZ,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    1: '#7570b3', //blueish
                                    2: '#1b9e77', //greenish,
                                    3: '#e6ab02', //light mostard
                                },
                                type: () => 'segment', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: sized
                                    ? (v, r, s, zf) => 1 * r * gviz.sPow(v / s.max, 0.25, 0)
                                    : undefined,
                                stripesOrientation: () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: sized ? 10 : 4,
                            cellInfoHTML: (c) =>
                                'Roman catholic church: ' +
                                c['1'] +
                                '<br>' +
                                'Protestant church: ' +
                                c['2'] +
                                '<br>' +
                                'Other, none, no data: ' +
                                c['3'],
                        }
                    )
                    //legend
                    if (sized)
                        app.layers[0].styles[0].legends.push(
                            new gviz.SizeLegend({
                                shape: 'square',
                                labelUnitText: 'people',
                                fillColor: '#ccc',
                                exaggerationFactor: 0.05,
                            })
                        )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Religion',
                            shape: 'square',
                            colCat: [
                                ['#7570b3', 'Roman catholic church'],
                                ['#1b9e77', 'Protestant church'],
                                ['#e6ab02', 'Other, none, no data'],
                            ], //.reverse(),
                        })
                    )
                } else if (layCode === 'habType') {
                    /* GEBTYPBAUWEISE			Gebäudetyp-Bauweise 		
 1	 Freistehendes Haus
 2	 Doppelhaus hälfte
 3	 Gereihtes Haus
 4	 Anderer Gebäudetyp */

                    app.addLayerFromDataset(
                        ds.GEBTYPBAUWEISE,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    1: '#33a02c', //green Detached house
                                    2: '#1f78b4', //blue Semi-detached houses
                                    3: '#6a3d9a', //purple Terraced house
                                    4: '#ff7f00', //orange Other type
                                },
                                type: () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1 * r * gviz.sPow(v / s.max, 0.25, 0),
                                stripesOrientation: () => 90,
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 12,
                            cellInfoHTML: (c) =>
                                'Detached house: ' +
                                c['1'] +
                                '<br>' +
                                'Semi-detached houses: ' +
                                c['2'] +
                                '<br>' +
                                'Terraced house: ' +
                                c['3'] +
                                '<br>' +
                                'Other type: ' +
                                c['4'],
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'square',
                            labelUnitText: 'habitations',
                            fillColor: '#ccc',
                            exaggerationFactor: 0.3,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Building type',
                            colCat: [
                                ['#33a02c', 'Detached house'],
                                ['#1f78b4', 'Semi-detached houses'],
                                ['#6a3d9a', 'Terraced house'],
                                ['#ff7f00', 'Other type'],
                            ], //.reverse(),
                        })
                    )

                    /*
                    GEBTYPGROESSE			Gebäudetyp-Größe 		
                    1	 Freistehendes Einfamilienhaus	taille du type de bâtiment		Maison individuelle pour une famille
                    2	 Einfamilienhaus: Doppelhaushälfte			  Maison individuelle : maison jumelée
                    3	 Einfamilienhaus: Reihenhaus			  Maison individuelle : maison mitoyenne
                    4	 Freistehendes Zweifamilienhaus			  Maison bifamiliale individuelle
                    5	 Zweifamilienhaus: Doppelhaushälfte			  Maison à 2 apts : maison jumelée
                    6	 Zweifamilienhaus: Reihenhaus			  Maison à 2 apts : maison mitoyenne
                    7	 Mehrfamilienhaus: 3-6 Wohnungen			  Immeuble : 3-6 appartements
                    8	 Mehrfamilienhaus: 7-12 Wohnungen			  Immeuble : 7-12 appartements
                    9	 Mehrfamilienhaus: 13 und mehr Wohnungen			  Immeuble à appartements : 13 appartements et plus
                    10	 Anderer Gebäudetyp			  Type de bâtiment différent
                                    */
                } else if (layCode === 'habYear') {
                    /*   BAUJAHR_MZ			Baujahr (Mikrozensus-Klassen) 
                                        1	 "before 1919"
                                        2	 "1919 - 1948"	
                                        3	 "1949 - 1978"	
                                        4	 "1979 - 1986"	
                                        5	 "1987 - 1990"	
                                        6	 "1991 - 1995"	
                                        7	 "1996 - 2000"
                                        8	 "2001 - 2004"	
                                        9	 "2005 - 2008"	
                                        10	 "2009 und later"  */

                    const labels = [
                        'before 1919',
                        '1919 - 1948',
                        '1949 - 1978',
                        '1979 - 1986',
                        '1987 - 1990',
                        '1991 - 1995',
                        '1996 - 2000',
                        '2001 - 2004',
                        '2005 - 2008',
                        '2009 and later',
                    ]

                    const col = d3.interpolateViridis
                    const colsDict = {}
                    for (let i = 1; i <= 10; i++) colsDict['' + i] = col((i - 1) / 9)

                    app.addLayerFromDataset(
                        ds.BAUJAHR_MZ,
                        [
                            new gviz.CompositionStyle({
                                color: colsDict,
                                type: () => 'flag', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1 * r * gviz.sPow(v / s.max, 0.25, 0),
                                stripesOrientation: () => 90,
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 12,
                            cellInfoHTML: (c) => {
                                const sb = []
                                for (let i = 1; i <= 10; i++)
                                    sb.push('<br>' + labels[i - 1] + ': ' + c['' + i])
                                return sb.join('')
                            },
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'square',
                            labelUnitText: 'habitations',
                            fillColor: '#ccc',
                            exaggerationFactor: 0.3,
                        })
                    )
                    const colCats = []
                    for (let i = 1; i <= 10; i++) colCats.push([col((i - 1) / 9), labels[i - 1]])
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Construction date',
                            shape: 'square',
                            colCat: colCats, //.reverse(),
                        })
                    )
                } else if (layCode === 'habHeat') {
                    /* HEIZTYP
1	 Fernheizung (Fernwärme)   Chauffage urbain (chauffage urbain)
2	 Etagenheizung			  chauffage au sol
3	 Blockheizung			  chauffe-bloc
4	 Zentralheizung			  chauffage central
5	 Einzel-/Mehrraumöfen (auch Nachtspeicherheizung)			  Chauffages pour une ou plusieurs pièces (également chauffage à accumulation de nuit)
6	 Keine Heizung im Gebäude oder in den Wohnungen			  Pas de chauffage dans l'immeuble ni dans les appartements */

                    app.addLayerFromDataset(
                        ds.HEIZTYP,
                        [
                            new gviz.CompositionStyle({
                                color: {
                                    fernw: '#1f78b4',
                                    sonst: 'rgb(180, 180, 180)',
                                    etagen: 'rgb(255, 164, 52)',
                                    zentral: '#33a02c',
                                },
                                type: () => 'piechart', //flag, piechart, ring, segment, radar, agepyramid, halftone
                                sizeCol: 'TOT',
                                size: (v, r, s, zf) => 1.2 * r * gviz.sPow(v / s.max, 0.25, 0),
                                //stripesOrientation: () => 90,
                                //agePyramidHeight: (c, r) => 0.95 * r,
                                blendOperation: (zf) => (zf < 4 ? 'multiply' : 'source-over'),
                            }),
                        ],
                        {
                            pixNb: 12,
                            cellInfoHTML: (c) =>
                                'Central heating: ' +
                                c.zentral +
                                '<br>' +
                                'Floor heating: ' +
                                c.etagen +
                                '<br>' +
                                'District heating: ' +
                                c.fernw +
                                '<br>' +
                                'Other: ' +
                                c.sonst,
                        }
                    )
                    //legend
                    app.layers[0].styles[0].legends.push(
                        new gviz.SizeLegend({
                            shape: 'circle',
                            labelUnitText: 'habitations',
                            fillColor: '#ccc',
                            exaggerationFactor: 0.3,
                        })
                    )
                    app.layers[0].styles[0].legends.push(
                        new gviz.ColorCategoryLegend({
                            title: 'Heating system',
                            colCat: [
                                ['#33a02c', 'Central heating'], //zentral
                                ['rgb(255, 164, 52)', 'Floor heating'], //etagen
                                ['#1f78b4', 'District heating'], //fernw
                                ['rgb(180, 180, 180)', 'Other'],
                            ], //.reverse(),
                        })
                    )
                } else console.error('Unexpected layer code: ' + layCode)

                //redraw
                app.cg.redraw()
            }

            //layer update
            document.querySelector('#layer').addEventListener('change', update)
            //sigma selection
            document.getElementById('sigma').oninput = update

            // show/hide labels
            document.querySelector('#label').addEventListener('change', function () {
                app.showLabels = this.checked
                app.cg.redraw()
            })

            // show/hide boundaries
            document.querySelector('#boundary').addEventListener('change', function () {
                app.showBoundaries = this.checked
                app.cg.redraw()
            })

            // show/hide background layer
            document.querySelector('#background').addEventListener('change', function () {
                app.showBgLayers = this.checked
                app.cg.redraw()
            })

            //select layer from URL
            const ls = gviz.getParameterByName('lay')
            if (ls) {
                const b = document.querySelector('#' + ls)
                if (b) b.checked = true
            }

            //initialise
            update()
        </script>

        <div
            style="
                position: absolute;
                right: 0px;
                bottom: 0px;
                width: auto;
                height: auto;
                padding: 1px;
                border: 0px;
                background: #ffffffcc;
            "
        >
            <span style="font-size: 0.8em">
                <a href="https://github.com/eurostat/gridviz" style="text-decoration: none">GridViz</a> | ©<a
                    href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html?nn=559100#Gitter"
                    style="text-decoration: none"
                    >Statistisches Bundesamt, Wiesbaden 2018</a
                >
                | ©<a href="https://eurogeographics.org" style="text-decoration: none"
                    >EuroGeographics</a
                ></span
            >
        </div>
    </body>
</html>
